name: åˆå¹¶ Release PR åè‡ªåŠ¨æ‰“ tagã€ç¿»æ ‡ç­¾å¹¶æ¸…ç†åˆ†æ”¯

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  tag_and_cleanup:
    # ä»…å¤„ç†å·²åˆå¹¶ä¸”æ ‡é¢˜åŒ…å« "chore(main): release" çš„ Release PR
    if: >
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.title, 'chore(main): release')
    runs-on: ubuntu-latest

    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
      HEAD_REF: ${{ github.event.pull_request.head.ref }}
      HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
      BASE_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆå®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä» PR æ ‡é¢˜è§£æç‰ˆæœ¬å·
        id: parse
        shell: bash
        run: |
          version="$(printf '%s' "$PR_TITLE" | sed -E 's/.*release ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')"
          if [[ -z "$version" ]]; then
            echo "âŒ æ— æ³•ä» PR æ ‡é¢˜è§£æç‰ˆæœ¬å·ï¼š$PR_TITLE"
            exit 1
          fi
          tag="v$version"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag"         >> "$GITHUB_OUTPUT"
          echo "ğŸ§© è§£æç»“æœï¼šversion=$version, tag=$tag"

      - name: ç‰ˆæœ¬å•è°ƒæ€§æ£€æŸ¥ï¼ˆé˜»æ­¢é™çº§ï¼‰
        shell: bash
        run: |
          want="${{ steps.parse.outputs.tag }}"
          latest="$(git tag --list 'v[0-9]*' --sort=-v:refname | head -n1 || true)"
          echo "ğŸ” æœŸæœ›æ‰“å‡ºçš„ tag: $want"
          if [[ -n "$latest" ]]; then
            w="${want#v}"; l="${latest#v}"
            echo "ğŸ“Œ å½“å‰ä»“åº“æœ€æ–° tag: $latest"
            if [ "$(printf '%s\n%s\n' "$l" "$w" | sort -V | head -n1)" != "$l" ]; then
              echo "âŒ è§£æå‡ºçš„ç‰ˆæœ¬ $w ä½äºç°æœ‰æœ€æ–°ç‰ˆæœ¬ $lï¼Œå·²ä¸­æ­¢ã€‚"
              exit 1
            fi
          else
            echo "â„¹ï¸ ä»“åº“æš‚æ— å†å² tagï¼Œè·³è¿‡é™çº§æ£€æŸ¥ã€‚"
          fi

      - name: æ£€æŸ¥è¿œç«¯æ˜¯å¦å·²å­˜åœ¨åŒå tag
        id: check
        shell: bash
        run: |
          tag="${{ steps.parse.outputs.tag }}"
          if git ls-remote --tags origin "refs/tags/${tag}" | grep -q "${tag}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ è¿œç«¯å·²å­˜åœ¨ tag: ${tag}ï¼Œè·³è¿‡åˆ›å»ºã€‚"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "âœ… è¿œç«¯ä¸å­˜åœ¨ tag: ${tag}ï¼Œå‡†å¤‡åˆ›å»ºã€‚"
          fi

      - name: åˆ›å»ºå¹¶æ¨é€ tagï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
        if: steps.check.outputs.exists == 'false'
        shell: bash
        run: |
          tag="${{ steps.parse.outputs.tag }}"
          sha="${MERGE_SHA}"
          if [[ -z "$sha" ]]; then
            echo "âŒ ç¼ºå°‘åˆå¹¶æäº¤ SHAï¼Œæ— æ³•æ‰“ tagã€‚"
            exit 1
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" "$sha" -m "Release $tagï¼ˆvia workflowï¼‰"
          git push origin "$tag"
          echo "ğŸ‰ å·²æ¨é€ tagï¼š$tag -> $sha"

      - name: ç¿»è½¬ PR æ ‡ç­¾ï¼ˆpending â†’ taggedï¼‰
        shell: bash
        run: |
          gh pr edit "$PR_NUMBER" --remove-label "autorelease: pending" || true
          gh pr edit "$PR_NUMBER" --add-label    "autorelease: tagged"
          echo "ğŸ·ï¸ å·²å°† PR #$PR_NUMBER æ ‡ç­¾æ”¹ä¸ºï¼šautorelease: tagged"

      - name: åˆ é™¤ release åˆ†æ”¯ï¼ˆä»…åŒä»“åº“åˆ†æ”¯ï¼‰
        shell: bash
        run: |
          echo "HEAD_REPO=$HEAD_REPO  BASE_REPO=$BASE_REPO"
          if [[ "$HEAD_REPO" == "$BASE_REPO" ]]; then
            echo "ğŸ§¹ åˆ é™¤åˆ†æ”¯ï¼š${HEAD_REF}"
            gh api -X DELETE "repos/${BASE_REPO}/git/refs/heads/${HEAD_REF}" || true
          else
            echo "â­ï¸ æ¥è‡ª fork çš„ PRï¼š${HEAD_REPO}ï¼Œè·³è¿‡åˆ é™¤åˆ†æ”¯ã€‚"
          fi
