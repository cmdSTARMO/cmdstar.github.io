name: åˆå¹¶å« Release-As çš„ PR åï¼Œç«‹å³è§¦å‘ release-pleaseï¼ˆå—æ§ç‰ˆï¼‰

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: kick-release-please-${{ github.ref }}
  cancel-in-progress: true

jobs:
  kick:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: è¯»å– PR æ ‡ç­¾ï¼ˆåªåœ¨æ˜¾å¼å…è®¸æ—¶è§¦å‘ï¼‰
        id: labels
        shell: bash
        run: |
          labels="$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name' || true)"
          echo "labels=$labels"
          if ! printf '%s' "$labels" | grep -qx 'use-release-as'; then
            echo "âœ… æœªå‘ç°æ ‡ç­¾ use-release-asï¼Œæœ¬æ¬¡ä¸è§¦å‘ release-pleaseã€‚"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸ”“ æ£€æµ‹åˆ° use-release-as æ ‡ç­¾ï¼Œå…è®¸è¯»å– Release-Asã€‚"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

      - name: æ£€å‡ºä»“åº“ï¼ˆå¸¦ tagï¼‰
        if: steps.labels.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä»…è¯»å–â€œåˆå¹¶æäº¤â€çš„ message ä¸­çš„ Release-As
        if: steps.labels.outputs.should_run == 'true'
        id: parse
        shell: bash
        run: |
          msg="$(gh api repos/${{ github.repository }}/commits/${MERGE_SHA} -q .commit.message || true)"
          echo "ğŸ§¾ åˆå¹¶æäº¤ä¿¡æ¯ï¼š"
          echo "$msg"
          ra="$(printf '%s' "$msg" | grep -ioE 'Release-As:\s*[0-9]+\.[0-9]+\.[0-9]+' | head -n1 | grep -ioE '[0-9]+\.[0-9]+\.[0-9]+')"
          if [[ -z "$ra" ]]; then
            echo "â„¹ï¸ åˆå¹¶æäº¤æœªåŒ…å« Release-As: x.y.zï¼Œè·³è¿‡ã€‚"
            echo "has_ra=false" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸ”– è§£æåˆ° Release-As: $ra"
            echo "has_ra=true"      >> "$GITHUB_OUTPUT"
            echo "release_as=$ra"   >> "$GITHUB_OUTPUT"
          fi

      - name: è®¡ç®—â€œæœ€æ–°å·²å‘å¸ƒç‰ˆæœ¬â€ï¼ˆä¼˜å…ˆ tagï¼Œå›é€€ manifestï¼‰
        if: steps.parse.outputs.has_ra == 'true'
        id: latest
        shell: bash
        run: |
          git fetch --tags --force || true
          latest_tag="$(git tag --list 'v[0-9]*' --sort=-v:refname | head -n1 || true)"
          if [[ -n "$latest_tag" ]]; then
            latest_ver="${latest_tag#v}"
            echo "ğŸ“Œ æœ€æ–° tagï¼š$latest_tag"
          else
            # å›é€€åˆ° manifestï¼šè§£æ ".": "1.2.3"
            if [[ -f ".release-please-manifest.json" ]]; then
              latest_ver="$(grep -oE '"\."\s*:\s*"[0-9]+\.[0-9]+\.[0-9]+"' .release-please-manifest.json | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
              echo "ğŸ“„ æœªå‘ç° tagï¼Œå›é€€åˆ° manifest ç‰ˆæœ¬ï¼š$latest_ver"
            fi
          fi
          echo "latest_ver=${latest_ver}" >> "$GITHUB_OUTPUT"

      - name: é™çº§ä¿æŠ¤ï¼ˆRelease-As ä¸å¾—ä½äºæœ€æ–°ç‰ˆæœ¬ï¼‰
        if: steps.parse.outputs.has_ra == 'true'
        shell: bash
        run: |
          want="${{ steps.parse.outputs.release_as }}"
          latest="${{ steps.latest.outputs.latest_ver }}"
          if [[ -n "$latest" ]]; then
            if [ "$(printf '%s\n%s\n' "$latest" "$want" | sort -V | head -n1)" != "$latest" ]; then
              echo "âŒ Release-As $want ä½äºæœ€æ–°ç‰ˆæœ¬ $latestï¼Œå·²æ‹¦æˆªï¼ˆè¯·æ”¹ä¸ºæ›´é«˜ç‰ˆæœ¬ï¼‰ã€‚"
              exit 1
            fi
          fi
          echo "âœ… ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡ï¼š$want >= $latest"

      - name: è§¦å‘ release-pleaseï¼ˆåˆ›å»º/åˆ·æ–° Release PRï¼‰
        if: steps.parse.outputs.has_ra == 'true'
        uses: googleapis/release-please-action@v4
        with:
          skip-github-release: true
          release-type: simple
          package-name: ${{ github.event.repository.name }}
          config-file: release-please-config.json
